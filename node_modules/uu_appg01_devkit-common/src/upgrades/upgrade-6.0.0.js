const Package = require("../package.js");
const PackageManager = require("../tools/package-manager.js");

const UU5DEVKIT_VERSION = "1.0.0";
const CLOUD_DEVKIT_VERSION = "0.12.0";

const upgradeVersion = __filename.replace(/.*upgrade-(.*)\.js$/, "$1");

module.exports = async function (config, templateInfo) {
  let { type } = templateInfo;

  let needsInstall;
  if (
    type.startsWith("uu5") ||
    type === "lib" ||
    (type === "nodejs-multi" &&
      config.getWorkspaceLibraryList(true).some((it) => it.type === "lib" || it.type === "uu5-lib"))
  ) {
    console.log(`${upgradeVersion} Updating project to use uu5devkitg01-plugin.`);
    let pack = Package.getSingletonSync();
    let pkg = pack.get();
    let hasDependency = pkg.devDependencies?.["uu5devkitg01-plugin"];
    let hasInstalledPlugin = resolvePackageJsonPath("uu5devkitg01-plugin");
    if (!hasDependency) {
      pkg.devDependencies ??= {};
      pkg.devDependencies["uu5devkitg01-plugin"] = "^" + UU5DEVKIT_VERSION;
      pack.saveSync();
    }
    needsInstall ||= !hasInstalledPlugin;
  }
  if (type === "nodejs-multi" || type === "nodejs-app" || type === "nodejs-service") {
    console.log(`${upgradeVersion} Updating project to use uu_cloudg02-devkit.`);
    let pack = Package.getSingletonSync();
    let pkg = pack.get();
    let hasDependency = !!pkg.devDependencies?.["uu_cloudg02-devkit"];
    let hasInstalledPlugin = !!resolvePackageJsonPath("uu_cloudg02-devkit");
    let updated;
    if (!hasDependency) {
      pkg.devDependencies ??= {};
      pkg.devDependencies["uu_cloudg02-devkit"] = "^" + CLOUD_DEVKIT_VERSION;
      updated = true;
    }
    if (type === "nodejs-multi" && !pkg.name.endsWith("~root")) {
      pkg.name = pkg.name + "~root";
      updated = true;
    }
    if (updated) {
      pack.saveSync();
    }
    needsInstall ||= !hasInstalledPlugin;
  }

  if (needsInstall) {
    console.log(`  ... installing plugin(s)`);
    await PackageManager.install({ inWholeWorkspace: true });
    try {
      delete require.cache[require.resolve("uu5devkitg01-plugin/package.json", { paths: ["."] })];
    } catch (e) {
      // ignore
    }
    try {
      delete require.cache[require.resolve("uu_cloudg02-devkit/package.json", { paths: ["."] })];
    } catch (e) {
      // ignore
    }
  }
};

function resolvePackageJsonPath(moduleName, baseDir) {
  let result;
  try {
    result = require.resolve(moduleName + "/package.json", { paths: [baseDir || "."] });
  } catch (e) {
    // ignore
  }
  return result;
}
