"use strict";

const { Uri } = require("uu_appg01_server").Uri;

// eslint-disable-next-line no-undef
scriptContext.dtoOut = { uuAppErrorMap: {} };
// eslint-disable-next-line no-undef
let { dtoIn, console, dtoOut, session } = scriptContext;

/*@@viewOn:imports*/
const { Validator } = require("uu_appg01_server").Validation;
const { ValidationHelper } = require("uu_appg01_server").AppServer;
const { UseCaseError } = require("uu_appg01_server").AppServer;
const { ProgressClient } = require("uu_consoleg02-uulib");

const <%=  context.projectClassName %>Client = uuScriptRequire("<%=  context.nameWithVendor %>/<%=  context.projectClassFile %>-client", {
  scriptRequireCacheEnabled: false,
});
/*@@viewOff:imports*/

/*@@viewOn:names*/
const Names = {
  SCRIP_LIB_NAME: "<%= context.nameWithVendor %>",
  SCRIPT_NAME: "<%=  context.projectClassName %>Init",
};
/*@@viewOff:names*/

/*@@viewOn:constants*/
const CMD_NAME = "init";
/*@@viewOff:constants*/

/*@@viewOn:errors*/
const Errors = {
  ERROR_PREFIX: `${Names.SCRIP_LIB_NAME}/${Names.SCRIPT_NAME}/`,

  InvalidDtoIn: class extends UseCaseError {
    constructor(dtoOut, paramMap, cause = null) {
      if (paramMap instanceof Error) {
        cause = paramMap;
        paramMap = {};
      }
      super({ dtoOut, paramMap, status: 400 }, cause);
      this.message = "DtoIn is not valid.";
      this.code = `${Errors.ERROR_PREFIX}invalidDtoIn`;
    }
  },
};
/*@@viewOff:errors*/

/*@@viewOn:scriptClient*/
class <%=  context.projectClassName %>InitClient {
  constructor(lockSecret) {
    this.lockSecret = lockSecret;
    this.progressClient = null;
    this.<%=  context.projectClassName.charAt(0).toLowerCase() + context.projectClassName.substr(1) %>Client = null;
    this.<%=  context.namespaceAppCamelCase %> = null;
  }

  async start() {
    this.<%=  context.projectClassName.charAt(0).toLowerCase() + context.projectClassName.substr(1) %>Client = new <%=  context.projectClassName %>Client(dtoIn.<%=  context.namespaceAppCamelCase %>Uri);
    this.<%=  context.namespaceAppCamelCase %> = await this.<%=  context.projectClassName.charAt(0).toLowerCase() + context.projectClassName.substr(1) %>Client.load();
    this.progressClient = await ProgressClient.createInstance(
      this.<%=  context.namespaceAppCamelCase %>.data.temporaryData.progressMap.uuConsoleUri,
      {
        code: this.<%=  context.namespaceAppCamelCase %>.data.temporaryData.progressMap.progressCode,
        lockSecret: this.lockSecret,
      },
      { session }
    );

    return this.<%=  context.namespaceAppCamelCase %>;
  }

  async initFinalize() {
    return this.<%=  context.projectClassName.charAt(0).toLowerCase() + context.projectClassName.substr(1) %>Client.initFinalize(this.lockSecret);
  }
}
/*@@viewOff:scriptClient*/

/*@@viewOn:validateDtoIn*/
const DtoInValidationSchema = `const script<%=  context.projectClassName %>InitDtoInType = shape({
  <%=  context.namespaceAppCamelCase %>Uri: string().isRequired(),
  lockSecret: hexa64Code().isRequired(),
})`;

function validateDtoIn(dtoIn, uuAppErrorMap = {}) {
  let dtoInValidator = new Validator(DtoInValidationSchema, true);
  let validationResult = dtoInValidator.validate("script<%=  context.projectClassName %>InitDtoInType", dtoIn);
  return ValidationHelper.processValidationResult(dtoIn, validationResult, uuAppErrorMap, `${Errors.ERROR_PREFIX}unsupportedKeys`, Errors.InvalidDtoIn);
}
/*@@viewOff:validateDtoIn*/

/*@@viewOn:helpers*/
/*@@viewOff:helpers*/

async function main() {
  await console.info(`Script <%=  context.namespaceAppCamelCase %> init started`);
  dtoOut.dtoIn = dtoIn;
  const uuAppErrorMap = dtoOut.uuAppErrorMap;

  // validates dtoIn
  await console.info(`Validating dtoIn schema.`);
  await console.info(JSON.stringify(dtoIn));

  validateDtoIn(dtoIn, uuAppErrorMap);

  // initialization <%=  context.projectClassName.charAt(0).toLowerCase() + context.projectClassName.substr(1) %> client and variables
  let mainContext = new <%=  context.projectClassName %>InitClient(dtoIn.lockSecret);
  let <%=  context.namespaceAppCamelCase %> = await mainContext.start();

  await console.log(`<uu5string/><UuConsole.Progress baseUri='${Uri.parse(scriptContext.scriptRuntime.getScriptConsoleUri()).baseUri}' progressCode='${mainContext.progressClient.progress.code}' />`);

  // TODO Add steps your application needs here...

  <%=  context.namespaceAppCamelCase %> = await mainContext.initFinalize();

  return { data: <%=  context.namespaceAppCamelCase %>, uuAppErrorMap };
}

main();
