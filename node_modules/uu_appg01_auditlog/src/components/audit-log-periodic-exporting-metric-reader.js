"use strict";

const { AuthenticationService } = require("uu_appg01_core-authentication");
const { Sys, UseCaseContext } = require("uu_appg01_core-appserver");
const { UriBuilder } = require("uu_appg01_core-uri");
const { Config } = require("uu_appg01_core-utils");

const { PeriodicExportingMetricReader } = require("uu_app_metricsg01");

class AuditLogPeriodicExportingMetricReader extends PeriodicExportingMetricReader {
  async onInitialized() {
    await UseCaseContext.create(async () => {
      let gateway = Config.getString("uu_app_gateway_uri") || "https://uuapp.plus4u.net";
      gateway = gateway.trim().replace(/\/$/, "");
      const appInfo = Sys.getAppInfo();
      const uuSubApp = appInfo.uuSubApp.replace("-server", "");
      const asid = Config.getString("asid");
      UseCaseContext.setUri(UriBuilder.parse(`${gateway}/${uuSubApp}/${asid}/uuAppLogstore/writeMetrics`));
      UseCaseContext.setSession(await AuthenticationService.authenticate({ systemIdentity: asid }));
      super.onInitialized();
    });
  }
}

module.exports = AuditLogPeriodicExportingMetricReader;
