"use strict";
const { DaoFactory } = require("uu_appg01_datastore");
const RequestAuditLogAbl = require("../abl/request-audit-log-abl");
const Morgan = require("morgan");

// DefaultUcHandler has MIDDLEWARE_ORDER = -500, we put UuAuditLog between them
const MIDDLEWARE_ORDER = -550;

const MIDDLEWARE_CODE = "uuAuditLog_middleware";

const stream = {
  write: function(message, encoding) {
    // Message is logged via "formatter"
    // represented by audit log itself.
  }
};

class AuditLogMiddleware {

  constructor() {
    this.name = "uuAuditLog middleware";
    this.code = MIDDLEWARE_CODE;
    this.order = MIDDLEWARE_ORDER;
    this.isDataStoreOn = DaoFactory.isDataStoreOn();
  }

  static log(tokens, req, res) {
    RequestAuditLogAbl.logRequest(MIDDLEWARE_CODE, req, res);
  }

  get pre() {
    if (!this.isDataStoreOn) {
      return;
    }
    return Morgan(AuditLogMiddleware.log, { stream });
  }

}

module.exports = AuditLogMiddleware;
