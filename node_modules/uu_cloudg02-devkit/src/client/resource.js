"use strict";

const CloudClient = require("./cloud-client.js");
const DevkitBaseError = require("../errors/devkit-base-error.js");

class Resource extends CloudClient {

  constructor(environment, opts = {}) {
    super(environment, opts, "<%resourceType%>");
  }

  async close(resourceType, oid) {
    try {
      let ucUri = this._getUseCaseUrl("close").replace("<%resourceType%>", resourceType);
      return await this._post(ucUri, {oid});
    } catch (e) {
      throw new DevkitBaseError("Closing uuAppResource failed.", null, e);
    }
  }

  async delete(resourceType, oid, tryNumber = 0) {
    try {
      let ucUri = this._getUseCaseUrl("delete").replace("<%resourceType%>", resourceType);
      return await this._post(ucUri, {oid});
    } catch (e) {
      if (e.responseBody && e.responseBody.includes("uuObjectAlreadyLocked") && tryNumber < 3) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        return await this.delete(resourceType, oid, ++tryNumber);
      }
      throw new DevkitBaseError("Deleting uuAppResource failed.", null, e);
    }
  }

}

module.exports = Resource;
