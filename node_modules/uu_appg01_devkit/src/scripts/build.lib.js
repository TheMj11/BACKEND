const fs = require("fs-extra");

const paths = require("../config/paths.js");
const helpers = require("../tools/helpers.js");

module.exports = class Build {
  constructor(config) {
    this.config = config;
  }
  async process() {
    // redirect iso/uu5 builds to uu5devkitg01-plugin (in case that someone manually updated devkit to 6.x but
    // npm scripts in package.json remained old)
    let templateType = helpers.getTemplateInfo().type;
    if (templateType.startsWith("uu5") || templateType === "lib") {
      return await helpers.forwardTaskToUu5Devkit("build", this.config);
    }

    console.log("Building project.");
    if (!this.config.getMode()) this.config.setMode("production");

    fs.ensureDirSync(paths.buildDir);

    let UpdateFromUuappJson = helpers.requireByTemplateType(__dirname + "/update-from-uuapp-json.js");
    await new UpdateFromUuappJson(this.config).process();
  }
};
