"use strict";

const { Config } = require("uu_appg01_core-utils");
const { MetricExporter } = require("uu_app_metricsg01");

const statusUpdater = require("../status-updater.js");

const UU_APP_METRICS_ENABLED = Config.getBoolean("uu_app_metrics_enabled");

class ProgressMetricExporter extends MetricExporter {
  constructor(meterProviderName, options = {}) {
    super(meterProviderName, options);
  }

  async export(metrics, callback) {
    if (this._shutdown) {
      // If the exporter is shutting down, by spec, we need to return FAILED as export result
      setImmediate(callback, { code: 1 });
      return;
    }

    if (UU_APP_METRICS_ENABLED && statusUpdater.metricsProgressUri) {
      await statusUpdater.update({ metrics: metrics?.uuAppMetrics || {}, atTime: new Date() });
    }

    setTimeout(() => callback({ code: 0 }), 0);
  }
}

module.exports = ProgressMetricExporter;